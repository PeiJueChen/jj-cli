"use strict";const e=require("../../untils/logs"),n=require("../../untils/fs"),a=require("../../untils/parse-config"),t=require("../../untils/format"),o=require("../../untils/common"),{signPlatforms:s}=require("../../constants/platforms"),{runCommand:r,commandExec:i}=require("../../untils/terminal"),l=require("path"),c=require("./../upload/common"),p="cc08d0408403c04968bcfbf738a7356bf6f4c8be";var u,g,d,f,y;const m=async({platform:n,currentWorkingDir:a,cliBinDir:t,projectname:o,folderpath:r,appcenter:i})=>{u=r||a,g=a,d=o,f=i;const l=n&&n.toLowerCase().trim();var c=s[l];if(!c)return void e.logFatal(`Only support ${Object.keys(s)} now.`);let p=new Map([["ios",async()=>{}],["android",async()=>{await b()}]]);y=c;const m=p.get(c);m&&m()},k=a=>{a||e.logFatal("Missing file");const t=l.resolve(u,...a.split("/"));return n.existsSync(t)||e.logFatal(`Cannot find file: ${a}`),t},j=a=>{const t=a.unsignedApk;var o=l.resolve(g,"app-release-unsigned.apk");if((s=o&&n.existsSync(o))||(s=(o=l.isAbsolute(t)&&l.resolve(t)||null)&&n.existsSync(o)),!s){o=l.resolve(u,...t.split("/"));var s=n.existsSync(o)}s||e.logFatal("Cannot find app-release-unsigned.apk"),a.unsignedApk=o},w=async()=>{const{config:e,configPathDiretory:n}=await a.parseConfig(u);return u=n,j(e),e},F=async(n,t)=>{try{return await a.askProjects(n,t)}catch(n){e.logFatal("Please write all `project` field as project name")}},v=async(e,a)=>{const o=a&&a.name,s=l.join(e,"../","signedApks");await n.mkdirAsyncRecursive(s);const r=`${o}-signed-${t.formatDate((new Date).getTime(),"yyyy-MM-dd-[hh-mm-ss]")}.apk`;return l.resolve(s,r)},$=e=>{n.existsSync(e)&&n.unlinkSync(e)},h=(e,n)=>{const a=l.join(e,"../",`${n}-unsigned-temp.apk`);return $(a),a};async function b(){await o.isInstalled("jarsigner")||e.logFatal("Cannot find `jarsigner`"),await o.isInstalled("zipalign")||e.logFatal("Cannot find `zipalign`");const n=await w(),a=n.unsignedApk,t=await F(n,d);e.logFriendly(`Your Project is : ${t.name}`);const s=t.keyStoreFile,r=k(s),c=t.alias||n.defaultAlias;c||e.logFatal("Cannot find alias");const p=t.storepass||t.keypass,u=t.keypass||t.storepass;p&&u||e.logFatal("Cannot find storepass / keypass");const g=await v(r,t),f=h(g,t.name);try{e.blue("................... Zipalign Start ..................."),await i(`zipalign -v -p 4 ${a} ${f}`),e.blue("................... Zipalign End ..................."),e.red("\n...........................................................................................\n"),e.blue("................... Sign Start ..................."),await i(`jarsigner -verbose -keystore ${r} -storepass ${p} -keypass ${u} -signedjar ${g} ${f} ${c}`),$(f),e.blue("................... Sign End ..................."),e.green(`Signed ${t.name}`),await o.openUrl(l.join(g,"../")),C(g,t.appcenter,y,n.defaultAppcenterToken)}catch(n){e.logError(n)}}const C=async(a,t,s=y,r="",i=f)=>{n.existsSync(a)||e.logFatal(`Cannot find your: ${a}`);const l=(t=t||{})[s]||{},u=Object.keys(l);if(0===u.length)return void e.logFriendly("Cannot find your appcenter config at jj.config.json");const g=i&&l[i];var d;if(g){g.userName&&g.appName&&g.group||e.logFatal("Please check your jj.config.json, Cannot find userName/appName/group"),d={...g,token:g.token||l.token||t.token||r||p,appPath:a,platform:s}}else{const n=u.filter((e=>{const n=l[e];return"object"==typeof n&&Object.keys(n).length>0&&n.userName&&n.appName&&n.group}));0===n.length&&e.logFatal("Please check your jj.config.json, Cannot find userName/appName/group"),e.logFriendly("Upload app to appcenter");var m=await o.askSelectList(n,"Group");const i=l[m];i||e.logFatal("Cannot find your Group info"),d={...i,token:i.token||l.token||t.token||r||p,appPath:a,platform:s}}c.uploadWithInfo(d)};module.exports={signPlatform:m,uploadToAppcenter:C};