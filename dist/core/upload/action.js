"use strict";const a=require("../../untils/logs"),t=require("../../untils/common"),e=require("./common"),{runSpawnCommand:r}=require("../../untils/terminal"),n=require("../../untils/parse-config"),o=require("./../sign/action"),{pgyerUpload:i,getNextVersion:p}=require("./pgyer"),l={ios:"ios",android:"android"};var c,s;const g=async(r,p,g,f,w,d,m,y,P)=>{c=d,s=m||p,await t.isInstalled("appcenter")||a.logFatal("Not found \"appcenter\", Please install first: 'npm install -g appcenter-cli'. ref: https://www.npmjs.com/package/appcenter-cli");const h=r&&r.toLowerCase().trim();var k=l[h];if(!k){let e=await t.askPlatform();if(!(k=l[e]))return void a.logFatal("Only support ios/android now.")}try{const{config:t,configPathDiretory:r}=await n.parseConfigPromise(s),l=await e.findPackageApp(k,p,w),g=l&&l.fullPath;try{var j=await n.askProjects(t,c)}catch(t){a.logFatal("Please write all `project` field as project name")}let d=u(j.pgyer),m=u(j.appcenter);if(d||m||a.logFatal("Cannot find your pgyer or appcenter config"),d)return void await i(k,g,j,t,P,y,f,p);m&&await o.uploadToAppcenter(g,j.appcenter,k,t.defaultAppcenterToken,y,P)}catch(a){e.uploadPlatform(k,p,f,w,P)}},f=async(e,r,o,i,g,f,w,d,m)=>{c=f,s=w||r;const y=e&&e.toLowerCase().trim();var P=l[y];if(!P){let e=await t.askPlatform();if(!(P=l[e]))return void a.logFatal("Only support ios/android now.")}try{const{config:t,configPathDiretory:e}=await n.parseConfigPromise(s);try{var h=await n.askProjects(t,c)}catch(t){a.logFatal("Please write all `project` field as project name")}let r=u(h.pgyer),o=u(h.appcenter);if(r||o||a.logFatal("Cannot find your pgyer or appcenter config"),r)return void await p(P,h,t,d)}catch(a){}},u=a=>a&&Object.keys(a).length>0,w=async()=>{await t.isInstalled("appcenter")||a.logFatal("Not found \"appcenter\", Please install first: 'npm install -g appcenter-cli'. ref: https://www.npmjs.com/package/appcenter-cli");try{await t.runTask("logout...",(async()=>{await r("appcenter logout"),a.logInfo("~End~")}))}catch(a){throw a}},d=async()=>{await t.isInstalled("appcenter")||a.logFatal("Not found \"appcenter\", Please install first: 'npm install -g appcenter-cli'. ref: https://www.npmjs.com/package/appcenter-cli");try{await t.runTask("login...",(async()=>{await r("appcenter login"),a.logInfo("~End~")}))}catch(a){throw a}};module.exports={uploadApp:g,logoutAppcenter:w,loginAppcenter:d,payerGetVersion:f};