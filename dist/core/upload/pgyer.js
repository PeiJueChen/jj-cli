"use strict";const e=require("../../untils/common"),o=require("../../untils/logs"),{uploadToPgyer:t,getNextVerion:n,updateInfo:a,clearAllVersions:l}=require("../../untils/pgyer-api"),{getSizeByPath:i}=require("../../untils/fs"),r=async(n,l,r,s,c,p,u)=>{var g,y,d,v,f;const j=r&&r.pgyer||{};let h=j[n.toLocaleLowerCase()];if(!p){const t=Object.keys(h);if(0===t.length)return void o.logFatal("Cannot find your appcenter config at jj.config.json");const n=t.filter((e=>{const o=h[e];return"object"==typeof o&&Object.keys(o).length>0}));0===n.length&&o.logFatal("Please check your jj.config.json, Cannot find pgyer group"),p=await e.askSelectList(n,"Group")}let w=(null===(g=h)||void 0===g?void 0:g[`v4${p}`])||(null===(y=h)||void 0===y?void 0:y[`${p}`]);var P;w&&0!==Object.keys(w).length||!p.includes("v4")||(p=p.replace("v4",""),w=null===(P=h)||void 0===P?void 0:P[`${p}`]);h=w,h&&0!==Object.keys(h).length||o.logFatal("Please set your pgy config");const b=h.apiKey||j.apiKey||s.defaultPgyerApiKey,k=(null===(d=h)||void 0===d?void 0:d.buildPassword)||(null==j?void 0:j.buildPassword),F=null===(v=h)||void 0===v?void 0:v.appKey,K=null===(f=h)||void 0===f?void 0:f.channel;b&&F||o.logFatal("Please set your apiKey & appKey of pgy first.");const $=await i(l);let L=`\n        Start Uploading...\n\n        Upload To "pgy": (https://www.pgyer.com)\n\n        Your Project name: ${r.name}\n\n        Your App: ${l}\n\n        Size: ${$}\n\n        `;k&&(L+=`\n        Your Build Password: ${k} \n\n        `),o.green(L);try{var O=await t(r.name,n.toLocaleLowerCase(),b,l,K,u,p);if(!O)return void o.logFatal("\n\n Upload Failure");o.green("\n\nUpload Successful. \n")}catch(e){o.logFatal("\n\n Upload Failure")}try{await a(b,F,k)}catch(e){}!c&&O&&await e.openUrl(O),process.exit(0)},s=async(t,a,i,r)=>{var s,c,p;const u=a&&a.pgyer||{};let g=u[t.toLocaleLowerCase()];if(!r){const t=Object.keys(g);if(0===t.length)return void o.logFatal("Cannot find your appcenter config at jj.config.json");const n=t.filter((e=>{const o=g[e];return"object"==typeof o&&Object.keys(o).length>0}));0===n.length&&o.logFatal("Please check your jj.config.json, Cannot find pgyer group"),r=await e.askSelectList(n,"Group")}let y=(null===(s=g)||void 0===s?void 0:s[`v4${r}`])||(null===(c=g)||void 0===c?void 0:c[`${r}`]);var d;y&&0!==Object.keys(y).length||!r.includes("v4")||(r=r.replace("v4",""),y=null===(d=g)||void 0===d?void 0:d[`${r}`]);g=y,g&&0!==Object.keys(g).length||o.logFatal("Please set your pgy config");const v=g.apiKey||u.apiKey||i.defaultPgyerApiKey,f=null===(p=g)||void 0===p?void 0:p.appKey;v&&f||o.logFatal("Please set your apiKey & appKey of pgy first.");try{l();var j=await n(v,f,r);console.log(j),process.exit(0)}catch(e){process.exit(1)}};module.exports={pgyerUpload:r,getNextVersion:s};