"use strict";const{post:l}=require("./http"),e=require("./PGYERAppUploader"),t="Env: uat",n="Env: prd",o="https://www.pgyer.com",i=l=>l?(l=l.toLocaleLowerCase()).includes("uat")||l.includes("development")||l.includes("test")?t:n:"",a=async(l,t,n,a,p)=>{var r;const u=new e(l),d={filePath:t,log:!0};n&&(d.buildChannelShortcut=n);let s=a||"";p&&(s+=`\n\n${i(p)}`),d.buildUpdateDescription=s;const c=await u.upload(d);console.log("result:",null==c?void 0:c.data);const v=n||(null==c||null===(r=c.data)||void 0===r?void 0:r.buildShortcutUrl);return console.log("Download Link:",o+"/"+v),o+"/"+v},p=async(e,t)=>{const n=await l("https://www.pgyer.com/apiv2/app/deleteApp",{_api_key:e,appKey:t});console.log("delApp:",n)},r=async(e,t,n)=>{const o=await l("https://www.pgyer.com/apiv2/app/buildDelete",{_api_key:e,appKey:t,buildKey:n});console.log("delVersion:",o)};var u=[];const d=async(e,t,n)=>{var o,i,a;n||(n=1);try{var p=await l("https://www.pgyer.com/apiv2/app/builds",{_api_key:e,appKey:t,page:n})}catch(l){}const r=(null==p||null===(o=p.data)||void 0===o?void 0:o.list)||[],s=null==p||null===(i=p.data)||void 0===i?void 0:i.pageCount,c=null==p||null===(a=p.data)||void 0===a?void 0:a.currentPage;u.push(...r),c<s&&await d(e,t,c+1);const v=[...u];return u=[],v},s=async(l,e,t)=>{var n;const o=(await d(l,e)).filter((l=>{var e;return null==l||null===(e=l.buildUpdateDescription)||void 0===e?void 0:e.includes(i(t))}));if(0===o.length)return"";o.sort(((l,e)=>{var t,n,o,i;let a=null==l||null===(t=l.buildVersion)||void 0===t?void 0:t.split(".").map(Number),p=null==e||null===(n=e.buildVersion)||void 0===n?void 0:n.split(".").map(Number);for(let l=0;l<Math.max(a.length,p.length);l++){const e=a[l]||0,t=p[l]||0;if(e>t)return-1;if(e<t)return 1}a=null==l||null===(o=l.buildVersionNo)||void 0===o?void 0:o.split(".").map(Number),p=null==e||null===(i=e.buildVersionNo)||void 0===i?void 0:i.split(".").map(Number);for(let l=0;l<Math.max(a.length,p.length);l++){const e=a[l]||0,t=p[l]||0;if(e>t)return-1;if(e<t)return 1}return 0}));let a=(null===(n=o[0])||void 0===n?void 0:n.buildVersion).split("."),p=parseInt(a[a.length-1]);a[a.length-1]=(p+1).toString();return a.join(".")},c=async(e,t,n)=>{const o={_api_key:e,appKey:t,buildInstallType:1,appLang:2,buildVersionType:2,appAutoSync:2,appShowPgyerCopyright:2,buildQrcodeShowAppIcon:1,appFeedbackStatus:2};n&&(o.buildInstallType=2,o.buildPassword=n);return await l("https://www.pgyer.com/apiv2/app/update",o)};module.exports={uploadToPgyer:a,delApp:p,delVersion:r,getAllVerions:d,getNextVerion:s,updateInfo:c};