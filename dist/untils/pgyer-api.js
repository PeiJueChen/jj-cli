"use strict";const{post:e}=require("./http"),l=require("./PGYERAppUploader"),t=require("./common"),n=require("./logs"),o="Env: uat",a="Env: prd",i="https://www.pgyer.com",p=e=>e?(e=e.toLocaleLowerCase()).includes("uat")||e.includes("development")||e.includes("test")?o:a:"",r=async(e,n,o,a,r)=>{const u=new l(e),s={filePath:n,log:!0};o&&(s.buildChannelShortcut=o);let d=a||"";r&&(d+=`\n\n${p(r)}`),s.buildUpdateDescription=d;try{var c;const e=await t.runTask(`${r} uploading...`,(async()=>await u.upload(s)));console.log("result:",null==e?void 0:e.data);const l=o||(null==e||null===(c=e.data)||void 0===c?void 0:c.buildShortcutUrl);return console.log("Download Link:",i+"/"+l),i+"/"+l}catch(e){}},u=async(l,t)=>{const n=await e("https://www.pgyer.com/apiv2/app/deleteApp",{_api_key:l,appKey:t});console.log("delApp:",n)},s=async(l,t,n)=>{const o=await e("https://www.pgyer.com/apiv2/app/buildDelete",{_api_key:l,appKey:t,buildKey:n});console.log("delVersion:",o)};var d=[];const c=async(l,t,n)=>{var o,a;n||(n=1);try{var i=await e("https://www.pgyer.com/apiv2/app/builds",{_api_key:l,appKey:t,page:n})}catch(e){}const p=(null==i||null===(o=i.data)||void 0===o?void 0:o.list)||[],r=null==i||null===(a=i.data)||void 0===a?void 0:a.pageCount,u=n;d.push(...p),u<r&&await c(l,t,u+1);return[...d]},v=()=>{d=[]},y=async(e,l,t)=>{var n;d=[];const o=await c(e,l),a=p(t),i=o.filter((e=>{var l;return null==e||null===(l=e.buildUpdateDescription)||void 0===l?void 0:l.includes(a)}));if(0===i.length)return"";i.sort(((e,l)=>{var t,n,o,a;let i=null==e||null===(t=e.buildVersion)||void 0===t?void 0:t.split(".").map(Number),p=null==l||null===(n=l.buildVersion)||void 0===n?void 0:n.split(".").map(Number);for(let e=0;e<Math.max(i.length,p.length);e++){const l=i[e]||0,t=p[e]||0;if(l>t)return-1;if(l<t)return 1}i=null==e||null===(o=e.buildVersionNo)||void 0===o?void 0:o.split(".").map(Number),p=null==l||null===(a=l.buildVersionNo)||void 0===a?void 0:a.split(".").map(Number);for(let e=0;e<Math.max(i.length,p.length);e++){const l=i[e]||0,t=p[e]||0;if(l>t)return-1;if(l<t)return 1}return 0}));let r=(null===(n=i[0])||void 0===n?void 0:n.buildVersion).split("."),u=parseInt(r[r.length-1]);r[r.length-1]=(u+1).toString();return r.join(".")},w=async(l,t,n)=>{const o={_api_key:l,appKey:t,buildInstallType:1,appLang:2,buildVersionType:2,appAutoSync:2,appShowPgyerCopyright:2,buildQrcodeShowAppIcon:1,appFeedbackStatus:2};n&&(o.buildInstallType=2,o.buildPassword=n);return await e("https://www.pgyer.com/apiv2/app/update",o)};module.exports={uploadToPgyer:r,delApp:u,delVersion:s,getAllVerions:c,getNextVerion:y,updateInfo:w,clearAllVersions:v};