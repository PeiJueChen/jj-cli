"use strict";const{post:e}=require("./http"),t=require("./PGYERAppUploader"),l=require("./common"),n=require("./logs"),o="Env: uat",a="Env: prd",p="https://www.pgyer.com",i=e=>e?(e=e.toLocaleLowerCase()).includes("uat")||e.includes("development")||e.includes("test")?o:a:"",r=async(e,n,o,a,p,r,u)=>{const s=new t(o),d={filePath:a,log:!0};p&&(d.buildChannelShortcut=p);let c=r||"";u&&(c+=`${u}:\n`,c+=`\n\n${i(u)}`),d.buildUpdateDescription=c;try{const t=await l.runTask(`${u} uploading...`,(async()=>await s.upload(d)));console.log("result:",null==t?void 0:t.data);var v=`app/${e}?env=${u}&platform=${n}`,y=`https://pgyer-enhance.web.app/${encodeURIComponent(v)}`;return console.log("Download Link:",y),y}catch(e){}},u=async(t,l)=>{const n=await e("https://www.pgyer.com/apiv2/app/deleteApp",{_api_key:t,appKey:l});console.log("delApp:",n)},s=async(t,l,n)=>{const o=await e("https://www.pgyer.com/apiv2/app/buildDelete",{_api_key:t,appKey:l,buildKey:n});console.log("delVersion:",o)};var d=[];const c=async(t,l,n)=>{var o,a;n||(n=1);try{var p=await e("https://www.pgyer.com/apiv2/app/builds",{_api_key:t,appKey:l,page:n})}catch(e){}const i=(null==p||null===(o=p.data)||void 0===o?void 0:o.list)||[],r=null==p||null===(a=p.data)||void 0===a?void 0:a.pageCount,u=n;d.push(...i),u<r&&await c(t,l,u+1);return[...d]},v=()=>{d=[]},y=async(e,t,l)=>{var n;d=[];const o=await c(e,t),a=i(l),p=o.filter((e=>{var t;return null==e||null===(t=e.buildUpdateDescription)||void 0===t?void 0:t.includes(a)}));if(0===p.length)return"";p.sort(((e,t)=>{var l,n,o,a;let p=null==e||null===(l=e.buildVersion)||void 0===l?void 0:l.split(".").map(Number),i=null==t||null===(n=t.buildVersion)||void 0===n?void 0:n.split(".").map(Number);for(let e=0;e<Math.max(p.length,i.length);e++){const t=p[e]||0,l=i[e]||0;if(t>l)return-1;if(t<l)return 1}p=null==e||null===(o=e.buildVersionNo)||void 0===o?void 0:o.split(".").map(Number),i=null==t||null===(a=t.buildVersionNo)||void 0===a?void 0:a.split(".").map(Number);for(let e=0;e<Math.max(p.length,i.length);e++){const t=p[e]||0,l=i[e]||0;if(t>l)return-1;if(t<l)return 1}return 0}));let r=(null===(n=p[0])||void 0===n?void 0:n.buildVersion).split("."),u=parseInt(r[r.length-1]);r[r.length-1]=(u+1).toString();return r.join(".")},w=async(t,l,n)=>{const o={_api_key:t,appKey:l,buildInstallType:1,appLang:2,buildVersionType:2,appAutoSync:2,appShowPgyerCopyright:2,buildQrcodeShowAppIcon:1,appFeedbackStatus:2};n&&(o.buildInstallType=2,o.buildPassword=n);return await e("https://www.pgyer.com/apiv2/app/update",o)};module.exports={uploadToPgyer:r,delApp:u,delVersion:s,getAllVerions:c,getNextVerion:y,updateInfo:w,clearAllVersions:v};